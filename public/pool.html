<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/e/e7/Twemoji12_1f913.svg" type="image/svg+xml">
<title>Турнир — Пул карт</title>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #121212;
    margin: 0;
    padding: 2rem;
    color: #eee;
  }
  h1 { text-align: center; color: #fff; margin-bottom: 2rem; }
  #controls { text-align: center; margin-bottom: 2rem; }
  button { background-color:#fff; color:#000; border:1px solid #555; padding:10px 20px; margin:5px; font-size:16px; border-radius:8px; cursor:pointer; transition:all 0.3s ease;}
  button:hover { background-color:#ddd; }
  .nickname-cell a.nickname { color:#fff; font-weight:bold; text-decoration:none; }
  .nickname-cell a.nickname:hover { text-decoration:underline; color:#ffb86b; }
  #user { font-weight:bold; color:#ccc; margin:10px 0; }
  table { width:100%; border-collapse:collapse; background-color:#1e1e1e; border-radius:12px; overflow:hidden; box-shadow:0 0 10px rgba(255,255,255,0.05); margin-bottom:1rem;}
  thead th { padding:14px; text-align:center; border-bottom:1px solid #333; background-color:#2a2a2a; color:#fff; font-weight:bold; }
  tbody td { padding:12px; text-align:center; border-bottom:1px solid #333; vertical-align:middle; }
  tr.main-row:hover { background-color:#2c2c2c; cursor:pointer; }
  tr.maps-row { display:none; background-color:#181818; }
  .maps-cell { padding:12px 18px; }
  .maps-list { display:flex; flex-direction:column; gap:9px; margin:6px 0; }
  .map-entry { display:flex; align-items:center; gap:12px; padding:10px; background-color:#222; border-radius:8px; }
  .map-entry a { color:#fff; font-weight:bold; text-decoration:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .map-cover { width:90px; height:55px; border-radius:6px; background-size:cover; background-position:center; flex-shrink:0; }
  .map-entry:hover { background-color:#2a2a2a; }
  .map-info { display:flex; justify-content:space-between; flex:1; color:#fff; font-weight:bold; }
  .map-info a:hover { text-decoration:underline; color:#ffb86b; }
  .nickname-cell { text-align:left; display:flex; align-items:center; gap:10px; }
  .position { width:80px; text-align:center; }
  .pp { width:10%; text-align:center; vertical-align:middle; }
  .position-text { width:80px; text-align:center; font-weight:bold; }
  .nickname-cell img { width:32px; height:32px; vertical-align:middle; border-radius:50%; box-shadow:0 0 3px rgba(255,255,255,0.2); }
  .map-pp { font-weight:700; color:#ffcc00; }

  /* карточки пула: 2 ряда с горизонтальной прокруткой */
  .pool-grid {
    display: grid;
    grid-auto-flow: column;
    grid-template-rows: repeat(2, 260px);
    gap: 16px;
    margin-bottom: 2rem;
    overflow-x: auto;
    padding-bottom: 4px;
  }
  .pool-card { background-color:#1e1e1e; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; height:240px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
  .pool-card:hover { transform:translateY(-4px); box-shadow:0 4px 20px rgba(255,255,255,0.15); }
  .pool-card img { width:100%; height:140px; object-fit:cover; display:block; }
  .pool-card-content {
  display: flex;
  flex-direction: column;
  justify-content: center; /* вертикальное центрирование внутри контента */
  flex: 1;
  padding: 8px;
}
  .pool-card-title {
  font-weight: bold;
  color: #fff;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  word-wrap: break-word;
  text-align: center;      /* горизонтальное центрирование текста */
  flex: 1;                 /* занимает всё доступное пространство между img и pp */
  display: flex;
  align-items: center;      /* вертикальное центрирование текста */
  justify-content: center;  /* горизонтальное центрирование текста */
}
  .pool-card-pp { font-weight:700; color:#ffcc00; text-align:right; margin-top:8px; }

  @media(max-width:600px){
    .pool-card{height:260px;}
    .pool-card img{height:110px;}
    .pool-card-title{font-size:clamp(12px,4vw,16px);}
  }
</style>
</head>
<body>
<div id="controls">
  <div id="user"></div>
  <div id="addMapControls" style="display:none;">
    <input type="text" id="mapLink" placeholder="Вставь ссылку на карту">
    <button onclick="addMap()">Добавить</button>
  </div>
  <button id="login">Войти через osu!</button>
  <button id="logout" style="display:none;">Выйти</button>
  <button id="participate" style="display:none;">Участвовать</button>
  <a href="/" class="button-link"><button>ПП кап</button></a>
</div>

<h1>Турнир: Пул кап</h1>

<div id="pool-cards" class="pool-grid"></div>

<table>
<thead>
<tr>
<th class="position">Позиция</th>
<th class="nickname-cell">Игрок</th>
<th class="pp">Сумма PP</th>
</tr>
</thead>
<tbody id="participants-body"></tbody>
</table>

<script>
function escapeHtml(str){if(str===null||str===undefined)return'';return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

async function addMap(){
  const url=document.getElementById('mapLink').value;
  const res=await fetch('/api/addMap',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url})});
  const data=await res.json();
  alert(data.success?"Карта добавлена!":"Ошибка: "+(data.error||'unknown'));
  if(data.success) await loadPool();
}

async function fetchUser(){
  const res=await fetch('/api/me');
  if(res.ok){
    const currentUser=await res.json();
    document.getElementById('user').innerText=`Привет, ${currentUser.username}!`;
    document.getElementById('login').style.display='none';
    document.getElementById('logout').style.display='inline-block';
    if(currentUser.username==='LLIaBKa'){document.getElementById('addMapControls').style.display='block';}
    const participantsRes=await fetch('/api/pool/participants');
    if(participantsRes.ok){
      const participants=await participantsRes.json();
      const isParticipating=participants.some(p=>p.nickname===currentUser.username);
      document.getElementById('participate').style.display=isParticipating?'none':'inline-block';
    }
  } else {
    document.getElementById('user').innerText='';
    document.getElementById('login').style.display='inline-block';
    document.getElementById('logout').style.display='none';
    document.getElementById('participate').style.display='none';
    document.getElementById('addMapControls').style.display='none';
  }
}

async function loadData(){
  const res=await fetch('/api/pool/participants');
  if(!res.ok)return;
  let data=await res.json();
  data.sort((a,b)=>(b.total_pp??0)-(a.total_pp??0));
  const tbody=document.getElementById('participants-body');
  tbody.innerHTML='';
  data.forEach((item,index)=>{
    const tr=document.createElement('tr');
    tr.className='main-row'; tr.dataset.playerId=item.id;
    tr.innerHTML=`<td class="position-text">${index+1}</td><td class="nickname-cell"><img src="${item.avatar?escapeHtml(item.avatar):''}" alt="avatar"><a href="https://osu.ppy.sh/users/${item.userid}" target="_blank" rel="noopener noreferrer" class="nickname" onclick="event.stopPropagation()">${escapeHtml(item.nickname)}</a></td><td class="pp">${Math.floor(item.total_pp??0)}</td>`;
    tbody.appendChild(tr);
    const mapsTr=document.createElement('tr'); mapsTr.className='maps-row'; mapsTr.id=`maps-row-${item.id}`;
    mapsTr.innerHTML=`<td class="maps-cell" colspan="3"><div id="maps-container-${item.id}" class="maps-list"></div></td>`;
    tbody.appendChild(mapsTr);
    tr.addEventListener('click',()=>toggleMaps(item.id));
  });
}

async function toggleMaps(playerId){
  const mapsTr=document.getElementById(`maps-row-${playerId}`);
  if(!mapsTr)return;
  if(mapsTr.style.display==='table-row'){mapsTr.style.display='none';return;}
  const container=document.getElementById(`maps-container-${playerId}`);
  container.innerHTML='<div style="color:#aaa">Загрузка...</div>';
  try{
    const res=await fetch(`/api/pool/player/${playerId}`);
    if(!res.ok){container.innerHTML='<div style="color:#f55">Ошибка загрузки карт</div>'; mapsTr.style.display='table-row'; return;}
    const maps=await res.json();
    if(!Array.isArray(maps)||maps.length===0){container.innerHTML='<div style="color:#aaa">Карт пока нет или игрок ещё не имеет записей (будут 0 pp).</div>'; mapsTr.style.display='table-row'; return;}
    const html=maps.map(m=>{
      const map=m.pool_maps||{};
      const title=escapeHtml(map.title||'Без названия');
      const bg=map.background_url||'';
      const url=map.map_url||'#';
      const pp=typeof m.pp==='number'?m.pp:0;
      return `<div class="map-entry"><div class="map-cover" style="background-image:url('${escapeHtml(bg)}')"></div><div class="map-info"><a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${title}</a><span class="map-pp">${pp} pp</span></div></div>`;
    }).join('');
    container.innerHTML=html; mapsTr.style.display='table-row';
  } catch(err){console.error('Ошибка получения карт игрока:',err); container.innerHTML='<div style="color:#f55">Ошибка при получении данных</div>'; mapsTr.style.display='table-row';}
}

async function loadPool(){
  const res=await fetch('/api/pool/maps'); const container=document.getElementById('pool-cards');
  if(!res.ok){container.innerHTML='Ошибка загрузки пула карт'; return;}
  const maps=await res.json(); container.innerHTML='';
  maps.forEach(map=>{
    const title=map.title??'Без названия';
    const bg=map.background_url??'';
    const url=map.map_url||(map.beatmap_id?`https://osu.ppy.sh/beatmaps/${map.beatmap_id}`:'#');
    const pp=map.best_score_pp??0;
    const card=document.createElement('div'); card.className='pool-card';
    card.innerHTML=`<a href="${url}" target="_blank" style="color:inherit;text-decoration:none; display:flex; flex-direction:column; height:100%;"><img src="${bg}" alt="beatmap cover"><div class="pool-card-content"><div class="pool-card-title">${title}</div><div class="pool-card-pp">${pp} pp</div></div></a>`;
    container.appendChild(card);
  });
}

document.getElementById('login').onclick=()=>window.location.href='/auth/login';
document.getElementById('logout').onclick=()=>window.location.href='/auth/logout';
document.getElementById('participate').onclick=async()=>{
  const res=await fetch('/api/pool/participate',{method:'POST'}); if(res.ok){await fetchUser(); await loadData();}
};

(async()=>{await fetchUser(); await loadPool(); await loadData();})();
</script>
</body>
</html>
