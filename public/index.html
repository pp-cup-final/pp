<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/e/e7/Twemoji12_1f913.svg" type="image/svg+xml">
  <title>–¢–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #121212;
      margin: 0;
      padding: 2rem;
      color: #eee;
    }
    table a {
      color: #fff;
      text-decoration: none;
      font-weight: bold;
    }
    table a:hover {
      color: #ff6347;
      text-decoration: underline;
    }
    h1 {
      text-align: center;
      color: #fff;
      margin-bottom: 2rem;
    }
    #controls {
      text-align: center;
      margin-bottom: 2rem;
    }
    button {
      background-color: #ffffff;
      color: #000;
      border: 1px solid #555;
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:hover {
      background-color: #ddd;
      color: #000;
    }
    #user {
      font-weight: bold;
      color: #ccc;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #1e1e1e;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(255,255,255,0.05);
    }
    th, td {
      padding: 14px;
      text-align: center;
      border-bottom: 1px solid #333;
    }
    th {
      background-color: #2a2a2a;
      color: #fff;
      font-weight: bold;
    }
    tr:hover {
      background-color: #2c2c2c;
    }
    img {
      border-radius: 50%;
      box-shadow: 0 0 5px rgba(255,255,255,0.1);
    }
    /* –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–ø-3 */
    .first {
      background: linear-gradient(90deg, #ffd70033, #ffd70011);
      font-weight: bold;
    }
    .first td {
      color: #ffd700;
    }
    .second {
      background: linear-gradient(90deg, #c0c0c033, #c0c0c011);
      font-weight: bold;
    }
    .second td {
      color: #c0c0c0;
    }
    .third {
      background: linear-gradient(90deg, #cd7f3233, #cd7f3211);
      font-weight: bold;
    }
    .third td {
      color: #cd7f32;
    }
    @media (max-width: 600px) {
      table, th, td {
        font-size: 12px;
      }
      button {
        padding: 8px 16px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div id="admin-panel" style="display: none; text-align: center; margin-bottom: 1rem;">
    <button id="clear-table">–û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
  </div>

  <div id="controls">
    <div id="user"></div>
    <button id="login">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ osu!</button>
    <button id="logout" style="display:none;">–í—ã–π—Ç–∏</button>
    <button id="participate" style="display:none;">–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å</button>
    <button id="unparticipate" style="display:none;">–ü–µ—Ä–µ—Å—Ç–∞—Ç—å —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å</button>
    <a href="/history" class="button-link"><button>–ò—Å—Ç–æ—Ä–∏—è</button></a>
    <a href="/pool" class="button-link" style="display: inline-block;"><button>–ü—É–ª –∫–∞–ø</button></a>
  </div>
  <h1>–¢–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h1>
  <table>
    <thead>
      <tr>
        <th>–ü–æ–∑–∏—Ü–∏—è</th>
        <th>–ê–≤–∞—Ç–∞—Ä</th>
        <th>–ù–∏–∫</th>
        <th>PP Start</th>
        <th>PP End</th>
        <th>PP Clear</th>
        <th>–û—á–∫–∏</th>
        <th id="admin-column" style="display:none;">–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
  let currentUser = null;

  function isSundayMoscow() {
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const moscow = new Date(utc + 3 * 60 * 60 * 1000); // MSK = UTC+3
    return moscow.getDay() === 0; // 0 = –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
  }

  function toggleButtonsVisibility() {
    const isSunday = isSundayMoscow();
    const participateBtn = document.getElementById("participate");
    const leaveBtn = document.getElementById("unparticipate");

    if (!participateBtn || !leaveBtn) return;

    if (!isSunday) {
      participateBtn.style.display = "none";
      leaveBtn.style.display = "none";
      return;
    }
  }

  async function fetchUser() {
    const res = await fetch('/api/me');
    if (res.ok) {
      currentUser = await res.json();
      document.getElementById('user').innerText = `–ü—Ä–∏–≤–µ—Ç, ${currentUser.username}!`;
      document.getElementById('login').style.display = 'none';
      document.getElementById('logout').style.display = 'inline-block';

      const participantsRes = await fetch('/api/data');
      const participants = await participantsRes.json();
      const isParticipating = participants.some(p => p.Nickname === currentUser.username);

      document.getElementById('participate').style.display = isParticipating ? 'none' : 'inline-block';
      document.getElementById('unparticipate').style.display = isParticipating ? 'inline-block' : 'none';

      if (currentUser.username === 'LLIaBKa') {
        document.getElementById('admin-panel').style.display = 'block';
        document.getElementById('admin-column').style.display = 'table-cell';
      } else {
        document.getElementById('admin-panel').style.display = 'none';
        document.getElementById('admin-column').style.display = 'none';
      }
    } else {
      currentUser = null;
      document.getElementById('user').innerText = '';
      document.getElementById('login').style.display = 'inline-block';
      document.getElementById('logout').style.display = 'none';
      document.getElementById('participate').style.display = 'none';
      document.getElementById('unparticipate').style.display = 'none';
      document.getElementById('admin-panel').style.display = 'none';
      document.getElementById('admin-column').style.display = 'none';
    }
    toggleButtonsVisibility();
  }

  async function loadData() {
    try {
      const res = await fetch('/api/data');
      if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
      const data = await res.json();
      const tbody = document.querySelector('tbody');
      tbody.innerHTML = '';
      data.forEach(item => {
        let rowClass = "";
        let crown = "";
        if (item.position === 1) {
          rowClass = "first";
          crown = " üëë";
        } else if (item.position === 2) {
          rowClass = "second";
        } else if (item.position === 3) {
          rowClass = "third";
        }

        const tr = document.createElement('tr');
        tr.className = rowClass;
        tr.innerHTML = `
          <td>${item.position}${crown}</td>
          <td><img src="${item.avatar}" alt="avatar" width="40" height="40" /></td>
          <td><a href="https://osu.ppy.sh/users/${item.userid}" target="_blank">${item.nickname}</a></td>
          <td>${item.ppstart}</td>
          <td>${item.ppend}</td>
          <td>${Math.floor(item.ppend-item.ppstart)}</td>
          <td>${item.points}</td>
          ${currentUser?.username === 'LLIaBKa' ? `<td><button onclick="deleteParticipant('${item.nickname}')">–£–¥–∞–ª–∏—Ç—å</button></td>` : ''}
        `;
        tbody.appendChild(tr);
      });
    } catch (e) {
      console.error(e);
    }
  }

  async function deleteParticipant(nickname) {
    if (confirm(`–£–¥–∞–ª–∏—Ç—å ${nickname}?`)) {
      await fetch(`/api/participant/${encodeURIComponent(nickname)}`, { method: 'DELETE' });
      loadData();
    }
  }

  document.getElementById('clear-table')?.addEventListener('click', async () => {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é —Ç–∞–±–ª–∏—Ü—É?')) {
      const res = await fetch('/api/participants', { method: 'DELETE' });
      const result = await res.json();
      if (res.ok) {
        await loadData();
        alert('–¢–∞–±–ª–∏—Ü–∞ –æ—á–∏—â–µ–Ω–∞');
      } else {
        alert(result.error || '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏');
      }
    }
  });

  document.getElementById('login').onclick = () => window.location.href = '/auth/login';
  document.getElementById('logout').onclick = () => window.location.href = '/auth/logout';

  document.getElementById('participate').onclick = async () => {
    const res = await fetch('/api/participate', { method: 'POST' });
    const result = await res.json();
    if (res.ok) {
      alert('–í—ã —É—Å–ø–µ—à–Ω–æ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ!');
      await fetchUser();
      await loadData();
    } else {
      alert(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—á–∞—Å—Ç–∏–∏');
    }
  };

  document.getElementById('unparticipate').onclick = async () => {
    const res = await fetch('/api/unparticipate', { method: 'POST' });
    const result = await res.json();
    if (res.ok) {
      alert('–í—ã –±–æ–ª—å—à–µ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ');
      await fetchUser();
      await loadData();
    } else {
      alert(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
    }
  };

  (async () => {
    await fetchUser();
    await loadData();
    toggleButtonsVisibility();
    setInterval(toggleButtonsVisibility, 60 * 1000);
  })();
  </script>
</body>
</html>
