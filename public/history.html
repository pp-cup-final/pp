<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/e/e7/Twemoji12_1f913.svg" type="image/svg+xml">
<title>История турнира</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #121212;
  margin: 0;
  padding: 2rem;
  color: #eee;
  text-align: center;
}
nav {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  backdrop-filter: blur(10px);
  background: rgba(18, 18, 18, 0.9);
  border-bottom: 1px solid #333;
  z-index: 1000;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.6rem 1.2rem;
  box-sizing: border-box;
  height: 7%;
}
h1 {
  padding-top: 2%;
}
.nav-left {
  font-weight: bold;
  font-size: 1.8rem;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-left: 3%;
}
.nav-center {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
}
.nav-center a, .nav-center button {
  color: #fff;
  text-decoration: none;
  margin: 0 0.9rem;
  position: relative;
  transition: color 0.3s;
  font-weight: 500;
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
}
.nav-center a:hover, .nav-center button:hover {
  color: #ff7a00;
}
.nav-center a.active, .nav-center button.active {
  color: #ff7a00;
}
.nav-center a.active::after, .nav-center button.active::after {
  content: "";
  position: absolute;
  left: 0; bottom: -4px;
  width: 100%; height: 2px;
  background: #ff7a00;
  border-radius: 1px;
  animation: underline 0.3s ease;
}
@keyframes underline {
  from { width: 0; opacity: 0.5; }
  to { width: 100%; opacity: 1; }
}
.nav-right {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  padding-right: 3%;
  font-weight: bold;
  color: #fff;
  justify-content: center;
  gap: 8px;
}
.nav-right #user {
  color: #ccc;
  white-space: nowrap;
  display: flex;
  align-items: center;
}
.nav-right #user a {
  color: #ccc;
  text-decoration: none;
  display: flex;
  align-items: center;
}
.nav-right #user :hover {
  color: #ff7a00;
}
.button-link button:hover {
  background-color: #ddd;
  color: #000;
}
.table-container {
  margin: 20px auto;
  width: 95%;
  max-width: 1200px;
  background: #1e1e1e;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  padding: 12px;
}
#login, #logout, #participate {
  background: #c265b4;
  color: white;
  border: none;
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s ease, color 0.3s;
  text-decoration: none;
  font-weight: 500;
}
#login:hover, #logout:hover, #participate:hover {
  background: #8e077a;
  color: white;
}
#participate {
  margin-left: 3%;
}
.summary-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
}
.summary-table th, .summary-table td {
  padding: 12px;
  border-bottom: 1px solid #2b2b2b;
  text-align: left;
}
.summary-table thead th {
  background: #232323;
  color: #fff;
  font-weight: 700;
}
.summary-row {
  cursor: pointer;
  transition: background 0.12s;
}
.summary-row:hover {
  background: #242424;
}
.detail-row {
  display: none;
  background: transparent;
}
.detail-cell {
  padding: 0;
  border: none;
}
.nested-table tr:hover, .detail-table tr:hover {
  background: #242424;
}
.detail-table {
  width: 100%;
  border-collapse: collapse;
  margin: 10px 0 16px 0;
}
.detail-table a {
  color: white;
  text-decoration: none;
  transition: color 0.2s ease;
}
.detail-table a:hover {
  color: #ff6347;
}
.detail-table th, .detail-table td {
  padding: 10px 12px;
  border-bottom: 1px solid #2b2b2b;
  font-size: 14px;
  text-align: center;
}
.detail-table thead th {
  background: #2a2a2a;
  font-weight: 700;
}
.detail-table td img {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  vertical-align: middle;
}
.detail-table th:nth-child(1), .detail-table td:nth-child(1) {
  width: 58px;
  max-width: 80px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 700;
  text-align: center;
  padding-left: 8px;
  padding-right: 8px;
}
.detail-table th:nth-child(2), .detail-table td:nth-child(2) {
  width: 48px;
  max-width: 48px;
  text-align: center;
  padding-left: 6px;
  padding-right: 0px;
}
.detail-table th:nth-child(3), .detail-table td:nth-child(3) {
  width: 220px;
  max-width: 220px;
  text-align: left;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-left: 2px;
  padding-right: 0px;
}
.modal {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.6);
  animation: fadeIn 0.2s ease;
}
.modal-content {
  background-color: #fff;
  margin: 8% auto;
  padding: 20px 30px;
  border: none;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  animation: slideDown 0.25s ease;
  color: #222;
}
.modal-content h2 {
  color: #111;
  text-align: center;
  margin-bottom: 1rem;
}
.modal-content p {
  color: #333;
  line-height: 1.5;
  text-align: left;
  font-size: 1rem;
}
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  cursor: pointer;
  transition: color 0.2s;
}
.close:hover {
  color: #333;
}
@keyframes fadeIn {
  from { opacity: 0; } to { opacity: 1; }
}
@keyframes slideDown {
  from { transform: translateY(-15px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
@media (max-width: 700px) {
  .detail-table th:nth-child(1), .detail-table td:nth-child(1) { width: 48px; max-width: 48px; }
  .detail-table th:nth-child(3), .detail-table td:nth-child(3) { width: 140px; max-width: 140px; }
}
.nested-row { display: none; background: #1a1a1a; }
.nested-cell { padding: 12px; }
.nested-table {
  width: 100%;
  border-collapse: collapse;
}
.nested-table th, .nested-table td {
  padding: 8px 10px;
  border-bottom: 1px solid #2b2b2b;
  text-align: left;
  font-size: 13px;
}
.nested-table thead th {
  background: #262626;
}
.nested-table th:first-child {
  text-align: left;
  padding-left: 8px;
}
.first { background: linear-gradient(90deg, #ffd70033, #ffd70011); font-weight: bold; }
.first td { color: #ffd700; }
.second { background: linear-gradient(90deg, #c0c0c033, #c0c0c011); font-weight: bold; }
.second td { color: #c0c0c0; }
.third { background: linear-gradient(90deg, #cd7f3233, #cd7f3211); font-weight: bold; }
.third td { color: #cd7f32; }
.small-muted { color: #bdbdbd; font-size: 13px; }
a {
  color: #4da6ff;
  text-decoration: none;
}
a:hover { text-decoration: underline; color: #80c0ff; }
.button-link button {
  background-color: #ffffff;
  color: #000;
  border: 1px solid #555;
  padding: 8px 14px;
  font-size: 14px;
  border-radius: 8px;
  cursor: pointer;
}
</style>
</head>
<body>
<nav>
  <div class="nav-left"><img src="https://upload.wikimedia.org/wikipedia/commons/e/e7/Twemoji12_1f913.svg" width="28" height="28" style="border-radius:50%;"><b style="margin-bottom: 5px;">History</b></div>
  <div class="nav-center">
    <a href="/">ПП кап</a>
    <a href="/pool">Пул кап</a>
    <a href="/history" class="active">История</a>
    <a href="/players" class="players">Участники</a>
    <button id="rulesBtn">Правила</button>
    <a href="https://discord.com/invite/4M5jDGDX96" target="_blank">Discord</a>
  </div>
  <div class="nav-right">
    <div id="user"></div>
    <button id="participate">Участвовать</button>
    <button id="login">Войти</button>
    <button id="logout" style="display:none;">Выйти</button>
  </div>
</nav>
<div id="rulesModal" class="modal">
  <div class="modal-content">
    <span id="closeModal" class="close">&times;</span>
    <h2>Правила ПП капа</h2>
    <p><b>1.</b> Для участия необходимо авторизоваться при помощи osu! аккаунта и нажать на кнопку участвовать.</p>
    <p><b>2.</b> Разрешается участвовать в ПП капе тем, кто присутствует на Дискорд сервере <a href="https://discord.com/invite/4M5jDGDX96">Шавоново</a>, имеет 4k pp и 30k плейкаунта.</p>
    <p><b>3.</b> Чтобы посмотреть на каких картах игрок получил ПП — кликните на него в таблице (раскроется список карт, которые дали игроку пп на этой неделе).</p>
    <p><b>4.</b> Очки высчитываются следующим образом — чистые пп умножаются на число, равное количеству тысяч пп, на которых эти чистые были получены.</p>
    <hr>
    <h2>Правила Пул капа</h2>
    <p><b>1.</b> Для участия необходимо авторизоваться при помощи osu! аккаунта и нажать на кнопку участвовать.</p>
    <p><b>2.</b> Разрешается участвовать в Пул капе тем, кто присутствует на Дискорд сервере <a href="https://discord.com/invite/4M5jDGDX96">Шавоново</a>.</p>
    <p><b>3.</b> Для скачивания карты — кликните на нужную карточку (откроется страница карты с нужной сложностью).</p>
    <p><b>4.</b> Чтобы посмотреть на какой карте сколько пп у определенного игрока — кликните на строчку этого игрока в таблице (раскроется таблица скоров).</p>
    <p><b>5.</b> Чтобы посмотреть скор — кликните на карту в скорах игрока (откроется osu! score).</p>
    <p><b>6.</b> Учет скоров работает таким образом, что все прошлые скоры на картах из пула не учитываются. Учитываются только те скоры, которые были поставлены после участия.</p>
    <hr>
    <p style="font-size: 0.9em; opacity: 0.8; text-align: center;">Обновление данных происходит автоматически один раз в 5 минут.</p>
  </div>
</div>

<h1>История ПП Капа</h1>
<div id="history" class="table-container"></div>

<h1>История Пул Капа</h1>
<div id="pool-history" class="table-container"></div>

<script>
/** Утилиты */
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

function formatDate(dateString) {
  if (!dateString) return '';
  const d = new Date(dateString);
  return d.toLocaleDateString('ru-RU', { year: 'numeric', month: '2-digit', day: '2-digit' });
}

function formatCycleRange(endIso, cycleDuration) {
  if (!endIso) return '';
  const end = new Date(endIso);
  const start = new Date(end);
  start.setDate(end.getDate() - cycleDuration);
  const fmt = (date) => date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
  return `${fmt(start)} – ${fmt(end)}`;
}

async function fetchUser() {
  try {
    const res = await fetch("/api/me");
    const user = res.ok ? await res.json() : null;
    currentUser = user;

    const userBox = document.getElementById("user");
    const loginBtn = document.getElementById("login");
    const logoutBtn = document.getElementById("logout");

    if (user) {
      userBox.innerHTML = `
        <a href="/profile/${user.id}" style="text-decoration: none; color: #ccc; display: flex; align-items: center;">
          <img src="${user.avatar_url || user.avatar}" width="28" height="28" style="border-radius:50%; vertical-align:middle; margin-right:8px;" alt="avatar">
          <b style="text-align:bottom;">${user.username}</b>
        </a>
      `;
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
    } else {
      userBox.textContent = "";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
    }
  } catch (err) {
    console.error("Ошибка /api/me:", err);
  }
}

function buildSummaryTable(weeks, onCreateDetailRow, isPool = false) {
  const table = document.createElement('table');
  table.className = 'summary-table';
  const thead = document.createElement('thead');
  thead.innerHTML = `<tr><th>Цикл</th><th>Дата начала</th></tr>`;
  table.appendChild(thead);
  const tbody = document.createElement('tbody');

  weeks.forEach((week, idx) => {
    const tr = document.createElement('tr');
    tr.className = 'summary-row';
    tr.dataset.weekIndex = idx;

    const weekEnd = new Date(week.date ?? week.tournament_date);
    const cycleDuration = isPool && weekEnd >= new Date('2025-10-17T00:00:00+03:00') ? 2 : 7;
    const weekStart = new Date(weekEnd);
    weekStart.setDate(weekEnd.getDate() - cycleDuration);
    const weekRange = formatCycleRange(weekEnd, cycleDuration);
    const startDate = formatDate(weekStart);

    tr.innerHTML = `<td>${escapeHtml(weekRange)}</td><td class="small-muted">${escapeHtml(startDate)}</td>`;
    tbody.appendChild(tr);

    const detailTr = document.createElement('tr');
    detailTr.className = 'detail-row';
    const detailTd = document.createElement('td');
    detailTd.className = 'detail-cell';
    detailTd.colSpan = 2;
    detailTr.appendChild(detailTd);
    tbody.appendChild(detailTr);

    const contentNode = onCreateDetailRow(week, idx);
    if (contentNode) detailTd.appendChild(contentNode);

    tr.addEventListener('click', () => {
      const isShown = detailTr.style.display === 'table-row';
      Array.from(tbody.querySelectorAll('.detail-row')).forEach(r => r.style.display = 'none');
      detailTr.style.display = isShown ? 'none' : 'table-row';
    });
  });

  table.appendChild(tbody);
  return table;
}

async function loadHistory() {
  try {
    const res = await fetch('/api/history');
    if (!res.ok) {
      document.getElementById('history').innerHTML = '<div class="small-muted">Ошибка загрузки истории ПП капа</div>';
      return;
    }
    const history = await res.json();
    const container = document.getElementById('history');
    container.innerHTML = '';

    const summary = buildSummaryTable(history, (week) => {
      const participants = Array.isArray(week.data) ? week.data.slice() : [];
      participants.sort((a, b) => {
        const pa = Number(a.points || 0);
        const pb = Number(b.points || 0);
        if (pb !== pa) return pb - pa;
        return (a.position || 0) - (b.position || 0);
      });
      participants.forEach((p, i) => p.position = p.position ?? (i + 1));

      const table = document.createElement('table');
      table.className = 'detail-table';
      table.innerHTML = `
        <thead>
          <tr>
            <th>Позиция</th>
            <th></th>
            <th>Игрок</th>
            <th>PPstart</th>
            <th>PPend</th>
            <th>PPclear</th>
            <th>Points</th>
          </tr>
        </thead>
      `;
      const tbody = document.createElement('tbody');

      participants.forEach((p) => {
        let rowClass = '';
        if (p.position === 1) rowClass = 'first';
        else if (p.position === 2) rowClass = 'second';
        else if (p.position === 3) rowClass = 'third';

        const tr = document.createElement('tr');
        tr.className = rowClass;
        const profileUrl = (p.userid || p.user_id) ? `https://osu.ppy.sh/users/${encodeURIComponent(p.userid || p.user_id)}` : '#';
        const avatar = escapeHtml(p.avatar || '');
        const nickname = escapeHtml(p.nickname || p.username || '');
        const ppstart = p.ppstart ?? '';
        const ppend = p.ppend ?? '';
        const ppclear = Math.floor((Number(ppend || 0) - Number(ppstart || 0)));
        const points = p.points ?? '';
        tr.innerHTML = `
          <td>${escapeHtml(String(p.position ?? ''))}</td>
          <td><img src="${avatar}" width="36" height="36" alt=""></td>
          <td style="text-align:left;"><a href="${profileUrl}" target="_blank" rel="noopener noreferrer">${nickname}</a></td>
          <td>${escapeHtml(String(ppstart))}</td>
          <td>${escapeHtml(String(ppend))}</td>
          <td>${escapeHtml(String(ppclear))}</td>
          <td>${escapeHtml(String(points))}</td>
        `;
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      return table;
    });

    container.appendChild(summary);
  } catch (err) {
    console.error('loadHistory error', err);
    document.getElementById('history').innerHTML = '<div class="small-muted">Ошибка загрузки истории ПП капа</div>';
  }
}

async function loadPoolHistory() {
  try {
    const res = await fetch('/api/pool/history');
    if (!res.ok) {
      document.getElementById('pool-history').innerHTML = '<div class="small-muted">Ошибка загрузки истории Пул капа</div>';
      return;
    }
    const history = await res.json();
    const container = document.getElementById('pool-history');
    container.innerHTML = '';

    const summary = buildSummaryTable(history, (week) => {
      const players = Array.isArray(week.data) ? week.data.slice() : [];
      players.sort((a, b) => (a.position || 0) - (b.position || 0));
      const table = document.createElement('table');
      table.className = 'detail-table';
      table.innerHTML = `
        <thead>
          <tr>
            <th>Позиция</th>
            <th></th>
            <th>Игрок</th>
            <th>Всего PP</th>
          </tr>
        </thead>
      `;
      const tbody = document.createElement('tbody');

      players.forEach(player => {
        if (Array.isArray(player.scores)) {
          player.scores.sort((a, b) => (Number(b.pp || 0) - Number(a.pp || 0)));
        }
        if (player.avatar_url) {
          player.user_id = player.avatar_url.match(/\/(\d+)\?/)?.[1];
        }
        const tr = document.createElement('tr');
        const profileUrl = (player.userid || player.user_id) ? `https://osu.ppy.sh/users/${encodeURIComponent(player.userid || player.user_id)}` : '#';
        let rowClass = '';
        if (player.position === 1) rowClass = 'first';
        else if (player.position === 2) rowClass = 'second';
        else if (player.position === 3) rowClass = 'third';
        tr.className = rowClass;
        tr.innerHTML = `
          <td>${escapeHtml(String(player.position ?? ''))}</td>
          <td><img src="${escapeHtml(player.avatar_url || '')}" width="36" height="36" alt=""></td>
          <td style="text-align:left;"><a href="${profileUrl}" target="_blank" rel="noopener noreferrer">${escapeHtml(player.nickname || '')}</a></td>
          <td>${escapeHtml(String(Math.round(Number(player.total_pp || 0))))}</td>
        `;
        tbody.appendChild(tr);

        if (Array.isArray(player.scores) && player.scores.length > 0) {
          const nestedTr = document.createElement('tr');
          nestedTr.className = 'nested-row';
          const td = document.createElement('td');
          td.className = 'nested-cell';
          td.colSpan = 4;

          const nestedTable = document.createElement('table');
          nestedTable.className = 'nested-table';
          nestedTable.innerHTML = `
            <thead>
              <tr>
                <th>Карта</th>
                <th style="width:110px;text-align:right; padding-right: 6px">PP</th>
              </tr>
            </thead>
          `;
          const nestedTbody = document.createElement('tbody');

          player.scores.forEach(s => {
            const title = s.title || s.beatmap_title || (`Map ${s.beatmap_id || ''}`);
            const beatmapId = s.beatmap_id || s.beatmap?.id || '';
            const scoreLink = s.score_id ? `https://osu.ppy.sh/scores/osu/${encodeURIComponent(s.score_id)}` : (beatmapId ? `https://osu.ppy.sh/beatmapsets/${encodeURIComponent(beatmapId)}` : '#');
            const ppVal = Math.round(Number(s.pp ?? s.score_pp ?? 0));
            const row = document.createElement('tr');
            row.innerHTML = `
              <td style="text-align:left;"><a href="${escapeHtml(scoreLink)}" target="_blank" rel="noopener noreferrer">${escapeHtml(title)}</a></td>
              <td style="text-align:right; padding-right: 3px">${escapeHtml(String(ppVal))}</td>
            `;
            nestedTbody.appendChild(row);
          });

          nestedTable.appendChild(nestedTbody);
          td.appendChild(nestedTable);
          nestedTr.appendChild(td);
          tbody.appendChild(nestedTr);

          tr.style.cursor = 'pointer';
          tr.addEventListener('click', (e) => {
            if (e.target.closest('a')) return;
            nestedTr.style.display = (nestedTr.style.display === 'table-row') ? 'none' : 'table-row';
          });
        }
      });

      table.appendChild(tbody);
      return table;
    }, true);

    container.appendChild(summary);
  } catch (err) {
    console.error('loadPoolHistory error', err);
    document.getElementById('pool-history').innerHTML = '<div class="small-muted">Ошибка загрузки истории Пул капа</div>';
  }
}

const modal = document.getElementById("rulesModal");
const rulesBtn = document.getElementById("rulesBtn");
const closeBtn = document.getElementById("closeModal");

function setRulesActive(active) {
  if (active) {
    rulesBtn.classList.add("active");
  } else {
    rulesBtn.classList.remove("active");
  }
}

rulesBtn.onclick = (e) => {
  e.preventDefault();
  modal.style.display = "block";
  setRulesActive(true);
};

closeBtn.onclick = () => {
  modal.style.display = "none";
  setRulesActive(false);
};

window.onclick = (e) => {
  if (e.target === modal) {
    modal.style.display = "none";
    setRulesActive(false);
  }
};

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && modal.style.display === 'block') {
    modal.style.display = "none";
    setRulesActive(false);
  }
});

document.getElementById('login').onclick = () => window.location.href = '/auth/login';
document.getElementById('logout').onclick = () => window.location.href = '/auth/logout';
document.getElementById('participate').onclick = () => alert("Функция участия доступна только на странице турнира!");

(async () => {
  await fetchUser();
  await loadHistory();
  await loadPoolHistory();
})();
</script>
</body>
</html>