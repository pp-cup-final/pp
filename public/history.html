<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/e/e7/Twemoji12_1f913.svg" type="image/svg+xml">
<title>История турнира</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #121212;
  margin: 0;
  padding: 2rem;
  color: #eee;
  text-align: center;
}
.button-link button:hover {
      background-color: #ddd;
      color: #000;
    }
/* общий контейнер таблиц */
.table-container {
  margin: 20px auto;
  width: 95%;
  max-width: 1200px;
  background: #1e1e1e;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  padding: 12px;
}

/* сводная таблица (неделя / дата начала) */
.summary-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
}
.summary-table th, .summary-table td {
  padding: 12px;
  border-bottom: 1px solid #2b2b2b;
  text-align: left;
}
.summary-table thead th {
  background: #232323;
  color: #fff;
  font-weight: 700;
}
.summary-row {
  cursor: pointer;
  transition: background 0.12s;
}
.summary-row:hover {
  background: #242424;
}

/* подробная таблица (разворачиваемая) */
.detail-row {
  display: none;
  background: transparent;
}
.detail-cell {
  padding: 0;
  border: none;
}

/* внутренняя таблица участников */
.detail-table {
  width: 100%;
  border-collapse: collapse;
  margin: 10px 0 16px 0;
}
.detail-table a{
  color: white;
  text-decoration: none;
  transition: color 0.2s ease;
}
.detail-table a:hover {
  color: #ff6347;
}
.detail-table th, .detail-table td {
  padding: 10px 12px;
  border-bottom: 1px solid #2b2b2b;
  font-size: 14px;
  text-align: center;
}
.detail-table thead th {
  background: #2a2a2a;
  font-weight: 700;
}
.detail-table td img {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  vertical-align: middle;
}

/* ---------- NEW: сузить колонки "Позиция" и "Игрок" ---------- */
/* Колонка "Позиция" (1-я колонка) — делаем узкой */
.detail-table th:nth-child(1),
.detail-table td:nth-child(1) {
  width: 58px;
  max-width: 80px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 700;
  text-align: center;
  padding-left: 8px;
  padding-right: 8px;
}

/* Колонка "Аватар" (2-я колонка) — фиксируем размер для иконки */
.detail-table th:nth-child(2),
.detail-table td:nth-child(2) {
  width: 48px;
  max-width: 48px;
  text-align: center;
  padding-left: 6px;
  padding-right: 0px;
}

/* Колонка "Игрок" (3-я колонка) — сокращаем место, обрезаем длинные ники с троеточием */
.detail-table th:nth-child(3),
.detail-table td:nth-child(3) {
  width: 220px;
  max-width: 220px;
  text-align: left;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-left: 2px;
  padding-right: 0px;
}

/* Для мобильных экранов уменьшаем фиксированные ширины */
@media (max-width: 700px) {
  .detail-table th:nth-child(1),
  .detail-table td:nth-child(1) { width: 48px; max-width:48px; }
  .detail-table th:nth-child(3),
  .detail-table td:nth-child(3) { width: 140px; max-width:140px; }
}

/* nested rows for pool scores */
.nested-row { display: none; background: #1a1a1a; }
.nested-cell { padding: 12px; }

/* nested table for player's scores */
.nested-table {
  width: 100%;
  border-collapse: collapse;
}
.nested-table th, .nested-table td {
  padding: 8px 10px;
  border-bottom: 1px solid #2b2b2b;
  text-align: left;
  font-size: 13px;
}
.nested-table thead th {
  background: #262626;
}
.nested-table th:first-child {
  text-align: left;
  padding-left: 8px;
}
/* top-3 styling */
.first { background: linear-gradient(90deg, #ffd70033, #ffd70011); font-weight:bold; }
.first td { color: #ffd700; }
.second { background: linear-gradient(90deg, #c0c0c033, #c0c0c011); font-weight:bold; }
.second td { color: #c0c0c0; }
.third { background: linear-gradient(90deg, #cd7f3233, #cd7f3211); font-weight:bold; }
.third td { color: #cd7f32; }

/* small helper */
.small-muted { color: #bdbdbd; font-size: 13px; }

a {
  color: #4da6ff;
  text-decoration: none;
}
a:hover { text-decoration: underline; color: #80c0ff; }

.controls {
  text-align: center;
  margin-bottom: 12px;
}
.button-link button {
  background-color: #ffffff;
  color: #000;
  border: 1px solid #555;
  padding: 8px 14px;
  font-size: 14px;
  border-radius: 8px;
  cursor: pointer;
}

</style>
</head>
<body>
<div class="controls">
  <a href="/" class="button-link"><button>Вернуться в ПП кап</button></a>
  <a href="/pool" class="button-link"><button>Вернуться в Пул кап</button></a>
</div>

<h1>История ПП Капа</h1>
<div id="history" class="table-container"></div>

<h1>История Пул Капа</h1>
<div id="pool-history" class="table-container"></div>

<script>
/** Утилиты */
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

function formatDate(dateString) {
  if (!dateString) return '';
  const d = new Date(dateString);
  return d.toLocaleDateString('ru-RU', { year: 'numeric', month: '2-digit', day: '2-digit' });
}

// возвращает "7 февраля – 14 февраля"
function formatWeekRange(startIso) {
  if (!startIso) return '';
  const start = new Date(startIso);
  const end = new Date(start);
  end.setDate(end.getDate() - 7);
  const fmt = (date) => date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
  return `${fmt(end)} – ${fmt(start)}`;
}

function buildSummaryTable(weeks, onCreateDetailRow) {
  const table = document.createElement('table');
  table.className = 'summary-table';
  const thead = document.createElement('thead');
  thead.innerHTML = `<tr><th>Неделя</th><th>Дата начала</th></tr>`;
  table.appendChild(thead);
  const tbody = document.createElement('tbody');

  weeks.forEach((week, idx) => {
    const tr = document.createElement('tr');
    tr.className = 'summary-row';
    tr.dataset.weekIndex = idx;

    const weekEnd = new Date(week.date ?? week.tournament_date); // дата конца недели
const weekStart = new Date(weekEnd);                          // копируем объект
weekStart.setDate(weekEnd.getDate() - 7);                     // отнимаем 7 дней

const weekRange = formatWeekRange(weekEnd);                  // диапазон недели, например "1 – 8 октября"
const startDate = formatDate(weekStart);                     // дата начала недели

tr.innerHTML = `<td>${escapeHtml(weekRange)}</td><td class="small-muted">${escapeHtml(startDate)}</td>`;
    tbody.appendChild(tr);

    // detail row
    const detailTr = document.createElement('tr');
    detailTr.className = 'detail-row';
    const detailTd = document.createElement('td');
    detailTd.className = 'detail-cell';
    detailTd.colSpan = 2;
    detailTr.appendChild(detailTd);
    tbody.appendChild(detailTr);

    const contentNode = onCreateDetailRow(week, idx);
    if (contentNode) detailTd.appendChild(contentNode);

    tr.addEventListener('click', () => {
      const isShown = detailTr.style.display === 'table-row';
      Array.from(tbody.querySelectorAll('.detail-row')).forEach(r => r.style.display = 'none');
      detailTr.style.display = isShown ? 'none' : 'table-row';
    });
  });

  table.appendChild(tbody);
  return table;
}

/** Загрузка истории ПП капа */
async function loadHistory() {
  try {
    const res = await fetch('/api/history');
    if (!res.ok) {
      document.getElementById('history').innerHTML = '<div class="small-muted">Ошибка загрузки истории ПП капа</div>';
      return;
    }
    const history = await res.json();
    const container = document.getElementById('history');
    container.innerHTML = '';

    // build summary table; for each week create detailed participants table
    const summary = buildSummaryTable(history, (week) => {
      // подробный блок: participants list
      const participants = Array.isArray(week.data) ? week.data.slice() : [];
      // сортируем по points desc / position asc
      participants.sort((a,b) => {
        const pa = Number(a.points || 0);
        const pb = Number(b.points || 0);
        if (pb !== pa) return pb - pa;
        return (a.position || 0) - (b.position || 0);
      });
      participants.forEach((p,i) => p.position = p.position ?? (i+1));

      const table = document.createElement('table');
      table.className = 'detail-table';
      table.innerHTML = `
        <thead>
          <tr>
            <th>Позиция</th>
            <th>Игрок</th>
            <th></th>
            <th>PPstart</th>
            <th>PPend</th>
            <th>PPclear</th>
            <th>Points</th>
          </tr>
        </thead>
      `;
      const tbody = document.createElement('tbody');

      participants.forEach((p) => {
        let rowClass = '';
        if (p.position === 1) rowClass = 'first';
        else if (p.position === 2) rowClass = 'second';
        else if (p.position === 3) rowClass = 'third';

        const tr = document.createElement('tr');
        tr.className = rowClass;
        const profileUrl = (p.userid || p.user_id) ? `https://osu.ppy.sh/users/${encodeURIComponent(p.userid || p.user_id)}` : '#';
        const avatar = escapeHtml(p.avatar || '');
        const nickname = escapeHtml(p.nickname || p.username || '');
        const ppstart = p.ppstart ?? '';
        const ppend = p.ppend ?? '';
        const ppclear = Math.floor((Number(ppend || 0) - Number(ppstart || 0)));
        const points = p.points ?? '';
        tr.innerHTML = `
          <td>${escapeHtml(String(p.position ?? ''))}</td>
          <td><img src="${avatar}" width="36" height="36" alt=""></td>
          <td style="text-align:left;"><a href="${profileUrl}" target="_blank" rel="noopener noreferrer">${nickname}</a></td>
          <td>${escapeHtml(String(ppstart))}</td>
          <td>${escapeHtml(String(ppend))}</td>
          <td>${escapeHtml(String(ppclear))}</td>
          <td>${escapeHtml(String(points))}</td>
        `;
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      return table;
    });

    container.appendChild(summary);
  } catch (err) {
    console.error('loadHistory error', err);
    document.getElementById('history').innerHTML = '<div class="small-muted">Ошибка загрузки истории ПП капа</div>';
  }
}

/** Загрузка истории Пул капа */
async function loadPoolHistory() {
  try {
    const res = await fetch('/api/pool/history');
    if (!res.ok) {
      document.getElementById('pool-history').innerHTML = '<div class="small-muted">Ошибка загрузки истории Пул капа</div>';
      return;
    }
    const history = await res.json();
    const container = document.getElementById('pool-history');
    container.innerHTML = '';

    // build summary; detail content will contain players & nested scores
    const summary = buildSummaryTable(history, (week) => {
      const players = Array.isArray(week.data) ? week.data.slice() : [];
      players.sort((a,b) => (a.position || 0) - (b.position || 0));
      const table = document.createElement('table');
      table.className = 'detail-table';
      table.innerHTML = `
        <thead>
          <tr>
            <th>Позиция</th>
            <th>Игрок</th>
            <th></th>
            <th>Всего PP</th>
          </tr>
        </thead>
      `;
      const tbody = document.createElement('tbody');

      players.forEach(player => {
        if (Array.isArray(player.scores)) {
          player.scores.sort((a,b) => (Number(b.pp || 0) - Number(a.pp || 0)));
        }
        if (player.avatar_url) {
    player.user_id = player.avatar_url.match(/\/(\d+)\?/)[1];
  }
        const tr = document.createElement('tr');
        const profileUrl = (player.userid || player.user_id) ? `https://osu.ppy.sh/users/${encodeURIComponent(player.userid || player.user_id)}` : '#';
        tr.innerHTML = `
          <td>${escapeHtml(String(player.position ?? ''))}</td>
          <td><img src="${escapeHtml(player.avatar_url || '')}" width="36" height="36" alt=""></td>
          <td style="text-align:left;"><a href="${profileUrl}" target="_blank" rel="noopener noreferrer">${escapeHtml(player.nickname || '')}</a></td>
          <td>${escapeHtml(String(Math.round(Number(player.total_pp || 0))))}</td>
        `;
        tbody.appendChild(tr);

        if (Array.isArray(player.scores) && player.scores.length > 0) {
          const nestedTr = document.createElement('tr');
          nestedTr.className = 'nested-row';
          const td = document.createElement('td');
          td.className = 'nested-cell';
          td.colSpan = 4;

          const nestedTable = document.createElement('table');
          nestedTable.className = 'nested-table';
          nestedTable.innerHTML = `
            <thead>
              <tr>
                <th >Карта</th>
                <th style="width:110px;text-align:right; padding-right: 6px">PP</th>
              </tr>
            </thead>
          `;
          const nestedTbody = document.createElement('tbody');

          player.scores.forEach(s => {
            const title = s.title || s.beatmap_title || (`Map ${s.beatmap_id || ''}`);
            const beatmapId = s.beatmap_id || s.beatmap?.id || '';
            const scoreLink = s.score_id ? `https://osu.ppy.sh/scores/osu/${encodeURIComponent(s.score_id)}` : (beatmapId ? `https://osu.ppy.sh/beatmapsets/${encodeURIComponent(beatmapId)}` : '#');
            const ppVal = Math.round(Number(s.pp ?? s.score_pp ?? 0));
            const row = document.createElement('tr');
            row.innerHTML = `
              <td style="text-align:left;"><a href="${escapeHtml(scoreLink)}" target="_blank" rel="noopener noreferrer">${escapeHtml(title)}</a></td>
              <td style="text-align:right; padding-right: 3px">${escapeHtml(String(ppVal))}</td>
            `;
            nestedTbody.appendChild(row);
          });

          nestedTable.appendChild(nestedTbody);
          td.appendChild(nestedTable);
          nestedTr.appendChild(td);
          tbody.appendChild(nestedTr);

          // кликаем на строку, но игнорируем клики по ссылкам
          tr.style.cursor = 'pointer';
tr.addEventListener('click', (e) => {
  // если клик на ссылке — ничего не делаем
  if (e.target.closest('a')) return;

  nestedTr.style.display = (nestedTr.style.display === 'table-row') ? 'none' : 'table-row';
});
        }
      });

      table.appendChild(tbody);
      return table;
    });

    container.appendChild(summary);
  } catch (err) {
    console.error('loadPoolHistory error', err);
    document.getElementById('pool-history').innerHTML = '<div class="small-muted">Ошибка загрузки истории Пул капа</div>';
  }
}


/** Запуск */
loadHistory();
loadPoolHistory();
</script>
</body>
</html>
