<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ò—Å—Ç–æ—Ä–∏—è —Ç—É—Ä–Ω–∏—Ä–∞</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #121212;
  margin: 0;
  padding: 2rem;
  color: #eee;
  text-align: center;
}
/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
.table-container {
  margin: 20px auto;
  width: 95%;
  max-width: 1200px;
  background: #1e1e1e;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}

/* –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ */
table {
  width: 100%;
  border-collapse: collapse;
  font-family: "Segoe UI", sans-serif;
  color: #e0e0e0;
  background-color: #1e1e1e;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 0 10px rgba(255,255,255,0.05);
  margin-top: 1rem;
}

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
th {
  background: #2a2a2a;
  color: #fff;
  font-weight: 600;
  padding: 12px 16px;
  text-align: center;
  font-size: 15px;
  border-bottom: 2px solid #3a3a3a;
}

/* –Ø—á–µ–π–∫–∏ */
td {
  padding: 10px 16px;
  text-align: center;
  border-bottom: 1px solid #333;
  font-size: 14px;
}

/* –ü–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–ø–æ–∑–∏—Ü–∏—è) */
td:first-child {
  font-weight: 600;
  color: #ffcc00;
}

/* –ê–≤–∞—Ç–∞—Ä */
td img {
  border-radius: 50%;
  width: 40px;
  height: 40px;
  border: 2px solid #444;
}

/* –ù–∞–≤–µ–¥–µ–Ω–∏–µ */
tr:hover {
  background: #262626;
  transition: 0.2s;
}

h1 {
  text-align: center;
  color: #fff;
  margin-bottom: 2rem;
}
button {
  background-color: #ffffff;
  color: #000;
  border: 1px solid #555;
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}
button:hover {
  background-color: #ddd;
  color: #000;
}
img {
  border-radius: 50%;
  box-shadow: 0 0 5px rgba(255,255,255,0.1);
}
table a {
  color: #fff;
  text-decoration: none;
  font-weight: bold;
}
table a:hover {
  color: #ff6347;
  text-decoration: underline;
}
details {
  user-select: none;
  border-radius: 12px;
  cursor: pointer;
}
details:hover {
  background: #2c2c2c;
}
details > summary {
  font-size: 20px;
  font-weight: bold;
  transition: color 1s;
}
details[open] > summary {
  color: #ff6347;
}
/* –¢–æ–ø-3 */
.first { background: linear-gradient(90deg, #ffd70033, #ffd70011); font-weight:bold; }
.first td { color: #ffd700; }
.second { background: linear-gradient(90deg, #c0c0c033, #c0c0c011); font-weight:bold; }
.second td { color: #c0c0c0; }
.third { background: linear-gradient(90deg, #cd7f3233, #cd7f3211); font-weight:bold; }
.third td { color: #cd7f32; }

.nested-row { display: none; background: #2a2a2a; }
.nested-row td { text-align: center; padding: 0; }

/* –í–ª–æ–∂–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (–∫–∞—Ä—Ç—ã –∏ PP) */
.nested-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
  border-radius: 10px;
  overflow: hidden;
}

.nested-table th{
  text-align: left;
  padding: 10px
}
.nested-table td {
  text-align: left;
  padding: 10px;
}

.nested-table th {
  background: #333;
  font-size: 14px;
}

.nested-table tbody tr {
  background: #202020;
  transition: background 0.2s;
}

.nested-table tbody tr:hover {
  background: #2c2c2c;
}

/* –°—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—ã */
.nested-table a {
  color: #4da6ff;
  text-decoration: none;
  font-weight: 500;
}
.nested-table a:hover {
  color: #80c0ff;
  text-decoration: underline;
}
</style>
</head>
<body>
<div>
  <a href="/" class="button-link"><button>–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</button></a>
  <h1>–ò—Å—Ç–æ—Ä–∏—è –ø–ø –∫–∞–ø–∞</h1>
</div>
<div id="history"></div>
<h1>–ò—Å—Ç–æ—Ä–∏—è –ø—É–ª –∫–∞–ø–∞</h1>
<div id="pool-history"></div>
<script>
function escapeHtml(str) {
  if (!str && str !== 0) return '';
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

// —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª–µ–π
function getUserId(obj) {
  if (!obj) return null;
  // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∫–ª—é—á–µ–π, –∫–æ—Ç–æ—Ä—ã–º–∏ –º–æ–∂–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å id
  return obj.userid ?? obj.userID ?? obj.userId ?? obj.user_id ?? obj.id ?? null;
}

// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞ osu: –µ—Å–ª–∏ –µ—Å—Ç—å numeric id ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ,
// –∏–Ω–∞—á–µ –ø—Ä–æ–±—É–µ–º –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –Ω–∏–∫ (—Ö–æ—Ç—è –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ –≤—Å–µ–≥–¥–∞ —Ö—Ä–∞–Ω–∏—Ç—å numeric id)
function buildOsuProfileUrl(obj) {
  const uid = getUserId(obj);
  if (uid) return `https://osu.ppy.sh/users/${encodeURIComponent(uid)}`;
  // fallback: –µ—Å–ª–∏ –Ω–µ—Ç id ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∏–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å). osu –º–æ–∂–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å,
  // –Ω–æ —ç—Ç–æ –ª—É—á—à–µ —á–µ–º —Å—Å—ã–ª–∫–∞ –Ω–∞ undefined.
  const nick = obj?.nickname || obj?.username || '';
  return `https://osu.ppy.sh/users/${encodeURIComponent(nick)}`;
}

async function loadHistory() {
  const res = await fetch("/api/history");
  const history = await res.json();
  const container = document.getElementById("history");
  container.innerHTML = "";

  history.forEach(week => {
    week.data.sort((a,b)=>b.points - a.points);
    week.data.forEach((p,i)=>p.position=i+1);

    const details = document.createElement("details");
    details.className="week";

    // –ª–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ ‚Äî –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ–∑–∂–µ
    week.data.forEach(p => console.log("history participant object:", p));

    const rowsHtml = week.data.map(p=>{
      // –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è id
      const profileUrl = buildOsuProfileUrl(p);
      let rowClass="", crown="";
      if(p.position===1){rowClass="first"; crown=" üëë";}
      else if(p.position===2){rowClass="second";}
      else if(p.position===3){rowClass="third";}
      const avatar = escapeHtml(p.avatar || '');
      const nickname = escapeHtml(p.nickname || p.username || `User ${getUserId(p) || ''}`);
      const ppstart = p.ppstart ?? '';
      const ppend = p.ppend ?? '';
      const points = p.points ?? '';
      const position = p.position ?? '';
      return `<tr class="${rowClass}">
        <td>${position}${crown}</td>
        <td><img src="${avatar}" width="40" height="40" alt=""></td>
        <td><a href="${profileUrl}" target="_blank" rel="noopener noreferrer">${nickname}</a></td>
        <td>${ppstart}</td>
        <td>${ppend}</td>
        <td>${Math.floor((ppend||0) - (ppstart||0))}</td>
        <td>${points}</td>
      </tr>`;
    }).join("");

    details.innerHTML = `
      <summary>${escapeHtml(week.date)}</summary>
      <table>
        <tr>
          <th>–ü–æ–∑–∏—Ü–∏—è</th>
          <th>–ê–≤–∞—Ç–∞—Ä</th>
          <th>–ò–≥—Ä–æ–∫</th>
          <th>PPstart</th>
          <th>PPend</th>
          <th>PPclear</th>
          <th>Points</th>
        </tr>
        ${rowsHtml}
      </table>
    `;
    container.appendChild(details);
  });
}

async function loadPoolHistory() {
  const res = await fetch("/api/pool/history");
  const history = await res.json();
  const container = document.getElementById("pool-history");
  container.innerHTML = "";

  history.forEach(week => {
    const details = document.createElement('details');
    const summary = document.createElement('summary');
    summary.textContent = week.tournament_date;
    details.appendChild(summary);

    const table = document.createElement('table');
    table.innerHTML = `
      <tr>
        <th>–ü–æ–∑–∏—Ü–∏—è</th>
        <th>–ê–≤–∞—Ç–∞—Ä</th>
        <th>–ò–≥—Ä–æ–∫</th>
        <th>–í—Å–µ–≥–æ PP</th>
      </tr>
    `;

    const tbody = document.createElement('tbody');

    week.data.forEach(player => {
      // –ª–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      console.log("pool-history player object:", player);

      // –æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–≥—Ä–æ–∫–∞
      const profileUrl = buildOsuProfileUrl(player);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(String(player.position ?? ''))}</td>
        <td><img src="${escapeHtml(player.avatar_url || '')}" width="30" alt=""></td>
        <td><a href="${profileUrl}" target="_blank" rel="noopener noreferrer">${escapeHtml(player.nickname || '')}</a></td>
        <td>${escapeHtml(String(player.total_pp ?? '0'))}</td>
      `;
      tbody.appendChild(tr);

      // —Å–∫—Ä—ã—Ç–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å–∫–æ—Ä–æ–≤
      if (player.scores && player.scores.length > 0) {
        const nestedTr = document.createElement('tr');
        nestedTr.className = "nested-row";
        const td = document.createElement('td');
        td.colSpan = 4;
        td.className = "nested-cell";

        // –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ç–∞–±–ª–∏—Ü–∞
        td.innerHTML = `
          <table class="nested-table">
            <thead>
              <tr>
                <th>–ö–∞—Ä—Ç–∞</th>
                <th>PP</th>
              </tr>
            </thead>
            <tbody>
              ${player.scores.map(s => `
                <tr>
                  <td>
                    <a href="https://osu.ppy.sh/beatmapsets/${encodeURIComponent(String(s.beatmap_id || ''))}" target="_blank">
                      ${escapeHtml(s.title || `Map ${s.beatmap_id || ''}`)}
                    </a>
                  </td>
                  <td>${escapeHtml(String(s.pp ?? '0'))}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        nestedTr.appendChild(td);
        nestedTr.style.display = "none"; // —Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        tbody.appendChild(nestedTr);

        tr.addEventListener('click', () => {
          nestedTr.style.display = nestedTr.style.display === 'table-row' ? 'none' : 'table-row';
        });
      }
    });

    table.appendChild(tbody);
    details.appendChild(table);
    container.appendChild(details);
  });
}

loadHistory();
loadPoolHistory();
</script>
</body>
</html>
